<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>HERE Vector Tiles with Custom GeoJSON Overlay</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
    <!-- Add Proj4js for coordinate transformation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #controls { 
            position: absolute; 
            top: 10px; 
            left: 10px; 
            background: rgba(255,255,255,0.9); 
            padding: 10px; 
            border-radius: 5px;
            z-index: 1;
        }
        #legend { 
            position: absolute; 
            bottom: 10px; 
            left: 10px; 
            background: rgba(255,255,255,0.9); 
            padding: 15px; 
            border-radius: 5px;
            z-index: 1;
            font-size: 12px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        .legend-color {
            display: inline-block;
            width: 12px;
            height: 12px;
            margin-right: 5px;
        }
        button {
            margin: 2px;
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            background-color: #007cbf;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #005a87;
        }
        button.active {
            background-color: #005a87;
        }
    </style>
</head>
<body>
    <div id="controls">
        <div>
            <strong>Data Source:</strong><br>
            <button id="data-btn" class="active" onclick="loadMaskData()">Mask Data</button>
            <button id="sample-btn" onclick="loadSampleData()">Sample Data</button>
        </div>
        <div id="status" style="margin-top: 10px; font-size: 12px;">
            Loading data...
        </div>
    </div>

    <div id="legend">
        <strong>Map Legend</strong><br>
        <div class="legend-item">
            <span class="legend-color" style="background-color: rgba(0, 100, 255, 0.5);"></span>
            Value: Low
        </div>
        <div class="legend-item">
            <span class="legend-color" style="background-color: rgba(0, 200, 255, 0.5);"></span>
            Value: Medium
        </div>
        <div class="legend-item">
            <span class="legend-color" style="background-color: rgba(255, 0, 0, 0.5);"></span>
            Value: High
        </div>
    </div>

    <div id="map"></div>
    <script>
        // Replace with your HERE API key
        const apiKey = 'xHhgsquXklvitNDTbfgp_tWdZ-rJWr4Njtl-66vFggk';

        // Sample GeoJSON data as fallback
        const sampleGeoJSONData = {
            "type": "FeatureCollection",
            "features": [
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "Point",
                        "coordinates": [72.8777, 19.0760]
                    },
                    "properties": {
                        "name": "Sample Point",
                        "value": 100.0
                    }
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [72.8700, 19.0800],
                            [72.8750, 19.0800],
                            [72.8750, 19.0850],
                            [72.8700, 19.0850],
                            [72.8700, 19.0800]
                        ]]
                    },
                    "properties": {
                        "name": "Sample Polygon",
                        "value": 200.0
                    }
                }
            ]
        };

        // Initialize the map
        const map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: {
                    hereVectorTiles: {
                        type: 'vector',
                        tiles: [
                            `https://vector.hereapi.com/v2/vectortiles/base/mc/{z}/{x}/{y}/omv?apikey=${apiKey}`
                        ],
                        tileSize: 512
                    },
                    'mask-data': {
                        type: 'geojson',
                        data: sampleGeoJSONData // Start with sample data
                    }
                },
                layers: [
                    // HERE Base Layers
                    {
                        id: 'landuse_here',
                        type: 'fill',
                        source: 'hereVectorTiles',
                        'source-layer': 'landuse',
                        paint: {
                            'fill-color': '#e0e0e0'
                        }
                    },
                    {
                        id: 'water_here',
                        type: 'fill',
                        source: 'hereVectorTiles',
                        'source-layer': 'water',
                        paint: {
                            'fill-color': '#a0c8f0'
                        }
                    },
                    {
                        id: 'buildings_here',
                        type: 'fill',
                        source: 'hereVectorTiles',
                        'source-layer': 'buildings',
                        paint: {
                            'fill-color': '#d9d9d9',
                            'fill-outline-color': '#bbbbbb'
                        }
                    },
                    {
                        id: 'roads_here',
                        type: 'line',
                        source: 'hereVectorTiles',
                        'source-layer': 'roads',
                        paint: {
                            'line-color': '#ffffff',
                            'line-width': 1
                        }
                    },
                    // Custom mask data layer
                    {
                        id: 'mask-polygons',
                        type: 'fill',
                        source: 'mask-data',
                        paint: {
                            // Color based on value property
                            'fill-color': [
                                'interpolate',
                                ['linear'],
                                ['get', 'value'],
                                0, 'rgba(0, 100, 255, 0.5)',
                                150, 'rgba(0, 200, 255, 0.5)',
                                300, 'rgba(255, 0, 0, 0.5)'
                            ],
                            'fill-outline-color': '#000000'
                        }
                    }
                ]
            },
            center: [72.8777, 19.0760], // Default center
            zoom: 12
        });

        // Add navigation controls
        map.addControl(new maplibregl.NavigationControl());

        // Function to update status
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        // Function to update active button
        function updateActiveButton(activeId) {
            const buttons = ['data-btn', 'sample-btn'];
            buttons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.classList.remove('active');
            });
            
            const activeBtn = document.getElementById(activeId);
            if (activeBtn) activeBtn.classList.add('active');
        }

        // Convert coordinates from Web Mercator (EPSG:3857) to WGS84 (EPSG:4326)
        function convertCoordsToWGS84(geoJson) {
            if (!geoJson || !geoJson.features) return geoJson;
            
            // Deep clone the GeoJSON to avoid modifying the original
            const convertedGeoJson = JSON.parse(JSON.stringify(geoJson));
            
            // Convert all coordinates in the features
            convertedGeoJson.features.forEach(feature => {
                if (feature.geometry.type === 'Polygon') {
                    feature.geometry.coordinates.forEach(ring => {
                        ring.forEach(coord => {
                            // Convert from Web Mercator to WGS84
                            const lonLat = proj4('EPSG:3857', 'EPSG:4326', coord);
                            coord[0] = lonLat[0];
                            coord[1] = lonLat[1];
                        });
                    });
                } else if (feature.geometry.type === 'Point') {
                    const lonLat = proj4('EPSG:3857', 'EPSG:4326', feature.geometry.coordinates);
                    feature.geometry.coordinates = lonLat;
                }
            });
            
            return convertedGeoJson;
        }

        // Function to load mask data from masks.geojson
        function loadMaskData() {
            updateStatus('Loading mask data...');
            updateActiveButton('data-btn');
            
            fetch('./masks_1.geojson')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Convert coordinates from Web Mercator to WGS84
                    const convertedData = convertCoordsToWGS84(data);
                    
                    // Calculate the center of the data for map positioning
                    const bounds = new maplibregl.LngLatBounds();
                    
                    convertedData.features.forEach(feature => {
                        if (feature.geometry.type === 'Polygon') {
                            feature.geometry.coordinates[0].forEach(coord => {
                                bounds.extend(coord);
                            });
                        }
                    });
                    
                    // Update the map source with converted data
                    map.getSource('mask-data').setData(convertedData);
                    
                    // Fit map to the data bounds with some padding
                    if (!bounds.isEmpty()) {
                        map.fitBounds(bounds, { padding: 50 });
                    }
                    
                    updateStatus(`Mask data loaded: ${convertedData.features.length} features`);
                })
                .catch(error => {
                    console.error('Error loading mask data:', error);
                    updateStatus('Failed to load mask data, using sample data');
                    map.getSource('mask-data').setData(sampleGeoJSONData);
                });
        }

        // Function to load sample data
        function loadSampleData() {
            updateStatus('Loading sample data...');
            updateActiveButton('sample-btn');
            
            map.getSource('mask-data').setData(sampleGeoJSONData);
            map.setCenter([72.8777, 19.0760]); // Mumbai coordinates
            map.setZoom(12);
            updateStatus(`Sample data loaded: ${sampleGeoJSONData.features.length} features`);
        }

        // Add popup functionality for mask layer
        map.on('click', 'mask-polygons', function (e) {
            const feature = e.features[0];
            const props = feature.properties;
            
            new maplibregl.Popup()
                .setLngLat(e.lngLat)
                .setHTML(`
                    <div style="min-width: 120px;">
                        <strong>Value:</strong> ${props.value || 'N/A'}<br>
                    </div>
                `)
                .addTo(map);
        });

        // Change cursor on hover
        map.on('mouseenter', 'mask-polygons', function () {
            map.getCanvas().style.cursor = 'pointer';
        });
        map.on('mouseleave', 'mask-polygons', function () {
            map.getCanvas().style.cursor = '';
        });

        // Load mask data on map load
        map.on('load', function() {
            loadMaskData();
        });
    </script>
</body>
</html>